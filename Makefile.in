PACKAGE = @PACKAGE@
VERSION = @VERSION@

SHELL = /bin/sh
top_srcdir = @top_srcdir@
srcdir = @srcdir@

.SUFFIXES:
.SUFFIXES: .c .o

CC = @CC@
DEFINES = @DEFS@ -DNO_SHARED_LIBS=1 -DLINUX -DPACKAGE=\"$(PACKAGE)\" -DVERSION=\"$(VERSION)\"
CFLAGS = -I. @CFLAGS@ $(DEFINES)
LDFLAGS = @LDFLAGS@ -L/usr/local/lib
LIBS = @LIBS@
INSTALL = @INSTALL@
HLLIB=@HLLIB@
HLLIB_INCLUDE=@HLLIB_INCLUDE@
LIBHL_DIR=@LIBHL_DIR@
libhlpath=@libhlpath@
prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
mandir = @mandir@
includedir = @includedir@
libdir = @libdir@
sysconfdir = @sysconfdir@

LCFLAGS=$(CFLAGS)
CFLAGS+=-static

DISTFILES =

IPLOGIN2_TARGET=iplogin2
IPLOGIN2_SOURCES=main.c engine.c find_interface.c misc.c filterchains.c filterchains2.c commands.c icmpping.c arpping.c config.c accounting.c trace.c mymalloc.c usernode.c
IPLOGIN2_OBJS=main.o engine.o find_interface.o misc.o filterchains.o filterchains2.o commands.o icmpping.o arpping.o config.o accounting.o trace.o mymalloc.o usernode.o

IPLOGIN2_CONFFILE=iplogin2.conf

ILADMIN_TARGET=iladmin
ILADMIN_SOURCES=iladmin.c
ILADMIN_OBJS=iladmin.o ilglue.o syslog_names.o

ILCOUNT_TARGET=ilcount
ILCOUNT_SOURCES=ilcount.c
ILCOUNT_OBJS=ilcount.o ilglue.o syslog_names.o

ILCMD_TARGET=ilcmd
ILCMD_SOURCES=ilcmd.c
ILCMD_OBJS=ilcmd.o

LIBACCLIB=acclib_test.la
LIBACCLIB_SRC=acclib_test.c
LIBACCLIB_OBJ=acclib_test.lo

LIB_IPLOGIN2=libiplogin2.a
LIB_SOURCES=ilglue.c syslog_names.c
LIB_OBJS=ilglue.o syslog_names.o
LIB_HEADER=iplogin2.h

PROGRAMS=$(IPLOGIN2_TARGET) $(ILADMIN_TARGET) $(ILCOUNT_TARGET) $(ILCMD_TARGET)
LIBRARIES=$(LIB_IPLOGIN2) $(LIBACCLIB)
TARGETS=$(PROGRAMS) $(LIBRARIES) $(IPLOGIN2_CONFFILE).inst
OBJS=$(IPLOGIN2_OBJS) $(ILADMIN_OBJS) $(ILCOUNT_OBJS) $(ILCMD_OBJS) $(LIB_OBJS) $(LIBACCLIB_OBJ)
SOURCES=$(IPLOGIN2_SOURCES) $(ILADMIN_SOURCES) $(ILCOUNT_SOURCES) $(ILCMD_SOURCES) $(LIB_SOURCES) $(LIBACCLIB_SRC)

IPTSRCDIR=@iptspath@
IPTVERSION=@IPTVERSION@
IPTINCDIR=$(IPTSRCDIR)/include
IPTLDLIB=$(IPTSRCDIR)/libiptc/libiptc.a $(IPTSRCDIR)/extensions/libext.a
IPTFLAGS=-DIPT_LIB_DIR=\"$(IPTLIBDIR)\" -rdynamic
IPT=$(IPTFLAGS) $(IPTLDLIB)

CFLAGS+=-I$(IPTINCDIR) -DIPTVERSION=\"$(IPTVERSION)\"

all: $(HLLIB) $(TARGETS)

install: all
	$(top_srcdir)/mkinstalldirs $(bindir) $(libdir) $(includedir) $(sysconfdir)
	$(INSTALL) -b $(PROGRAMS) $(bindir)/
	./libtool $(INSTALL) -b $(LIBRARIES) $(libdir)/
	$(INSTALL) -b -m0644 $(LIB_HEADER) $(includedir)/
	if test ! -z "$(HLLIB)"; then $(INSTALL) -b $(HLLIB) $(libdir)/; $(INSTALL) -b -m0644 $(HLLIB_INCLUDE) $(includedir); fi
	if test ! -f $(sysconfdir)/$(IPLOGIN2_CONFFILE); then install -m0600 $(IPLOGIN2_CONFFILE).inst $(sysconfdir)/$(IPLOGIN2_CONFFILE); else echo Preserving existing $(sysconfdir)/$(IPLOGIN2_CONFFILE); fi
	./libtool --mode=finish $(libdir)
	
##	$(top_srcdir)/mkinstalldirs $(mandir)/man1
##	$(INSTALL) $(MAN) $(mandir)/man1/$(MAN)

$(IPLOGIN2_TARGET): $(IPLOGIN2_OBJS) $(IPTSRCDIR)/extensions/libext.a
	$(CC) $(CFLAGS) -o $(IPLOGIN2_TARGET) $(IPLOGIN2_OBJS) $(IPT) $(LDFLAGS) $(LIBS)
	strip $(IPLOGIN2_TARGET)

$(IPTSRCDIR)/extensions/libext.a:
	(cd $(IPTSRCDIR); make NO_SHARED_LIBS=1)

$(LIBACCLIB): $(LIBACCLIB_SRC)
	./libtool $(CC) -c $(LIBACCLIB_SRC) -o $(LIBACCLIB_OBJ)
	./libtool $(CC) -module $(LIBACCLIB_OBJ) -o $(LIBACCLIB) -rpath $(libdir) $(LDFLAGS) $(LIBS)

$(libhlpath)/libhl.a:
	(cd $(libhlpath); make)

$(IPLOGIN2_CONFFILE).inst: $(IPLOGIN2_CONFFILE).sample
	sed 's@/opt/iplogin2/lib@'"$(libdir)"'@g' < $(IPLOGIN2_CONFFILE).sample > $(IPLOGIN2_CONFFILE).inst

$(ILADMIN_TARGET): $(ILADMIN_OBJS) $(LIB_IPLOGIN2)
	$(CC) $(CFLAGS) -o $(ILADMIN_TARGET) $(ILADMIN_OBJS) $(LIB_IPLOGIN2) $(LDFLAGS) $(LIBS)
	strip $(ILADMIN_TARGET)

iladmin.o: iladmin.c
	$(CC) $(CFLAGS) -DCONFFILE=\"$(sysconfdir)/$(IPLOGIN2_CONFFILE)\" -c iladmin.c -o iladmin.o

$(ILCOUNT_TARGET): $(ILCOUNT_OBJS) $(LIB_IPLOGIN2)
	$(CC) $(CFLAGS) -o $(ILCOUNT_TARGET) $(ILCOUNT_OBJS) $(LIB_IPLOGIN2) $(LDFLAGS) $(LIBS)
	strip $(ILCOUNT_TARGET)

ilcount.o: ilcount.c
	$(CC) $(CFLAGS) -DCONFFILE=\"$(sysconfdir)/$(IPLOGIN2_CONFFILE)\" -c ilcount.c -o ilcount.o

$(ILCMD_TARGET): $(ILCMD_OBJS) $(LIB_IPLOGIN2)
	$(CC) $(CFLAGS) -o $(ILCMD_TARGET) $(ILCMD_OBJS) $(LIB_IPLOGIN2) $(LDFLAGS) $(LIBS)
	strip $(ILCMD_TARGET)

ilcmd.o: ilcmd.c
	$(CC) $(CFLAGS) -DCONFFILE=\"$(sysconfdir)/$(IPLOGIN2_CONFFILE)\" -c ilcmd.c -o ilcmd.o

$(LIB_IPLOGIN2): $(LIB_OBJS)
	ar -r $(LIB_IPLOGIN2) $(LIB_OBJS)
	ranlib $(LIB_IPLOGIN2)

clean:
	./libtool rm -f $(TARGETS) $(OBJS) core

distclean: clean config-clean
	if test ! -z "$(LIBHL_DIR)"; then (cd $(LIBHL_DIR); if test -f ./Makefile; then make distclean; fi); fi
	rm -rf .libs

config-clean: confclean-recursive

confclean-recursive: cfg-clean

cfg-clean:
	/bin/rm -f Makefile autoconfig.h config.status config.cache config.log libtool

mostlyclean: clean

maintainer-clean: clean

# automatic re-running of configure if the configure.in file has changed
${srcdir}/configure: configure.in 
	cd ${srcdir} && autoconf

# autoheader might not change config.h.in, so touch a stamp file
${srcdir}/config.h.in: stamp-h.in
${srcdir}/stamp-h.in: configure.in 
		cd ${srcdir} && autoheader
		echo timestamp > ${srcdir}/stamp-h.in

config.h: stamp-h
stamp-h: config.h.in config.status
	./config.status
Makefile: Makefile.in config.status
	./config.status
config.status: configure
	./config.status --recheck



