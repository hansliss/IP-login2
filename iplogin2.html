<html><head><title>NetLogon: IP-login ver 2</title></head><body>
<center><h1>NetLogon: IP-login ver 2</h1></center>
<i><center>Pelle Andersson</center>
<center>Uppsala Universitet IT-Stöd</center>
<center>2003-10-11</center>
<center>Based on swedish version by Hans Liss, 2003-01-22</center></i>
<br/>
<h2>Short description</h2>
<p>
NetLogon is a system for controlling workstation access to a network. Its primary use is when there is a need to
keep track of who is accessing the network, and the workstation operating system lacks login procedure or is not
under the network operator's control.
</p>
<p>
In its simplest form, NetLogon is run on a <a href="http://bifrost.slu.se">Bifrost</a> router. Any
unauthenticated user who tries accessing the network is blocked. In case of web access, the request
is redirected to a webpage generated by a cgi on the router. This cgi presents a HTML form which the user
fills out with his/her username and password. After a successful login, the cgi asks the <b>iplogin</b>
daemon on the router to open access for the users IP address in the iptables filters.
The daemon also starts monitoring the workstation to detect when the workstation goes offline.
The IP address is then removed from the iptables, which results in the user being logged out.
</p>
<p>
The authentication can be done against different types of authentication systems. The three components;
the cgi (and the hosting webserver), the autentication server and the iplogin daemon, can be spread out
on different machines, as long as the iplogin daemon runs on the router (it has to be able to modify
the router's access filters).
</p>
<h2>The iplogin daemon</h2>
<p>
There are quite a few configuration parameters and they are therefore stored in a configuration file.
The format is described below.
</p>
<p>
The iplogin daemon has the following features (the term user means a tuple consisting of a user name and an IP address):
<ul>
<li>The process listens to a tcp port on which is receives commands. Commands are sent either from the cgi or from the administration command line interface, which can be run locally or remotely</li>
<li>The following operations are supported:
<ul>
<li>Add a new user</li>
<li>Check if a user is logged on</li>
<li>Check status and statistics for a user</li>
<li>Remove a user (log out a user)</li>
<li>Reload all filters - "refresh"</li>
<li>Check status for all active users</li>
<li>Restore to initial state - unload all filters etc.</li>
<li>Save the list of active users to a file</li>
<li>Load the list of active users from a file</li>
<li>Count the number of users currently logged on</li>
</ul>
</li>
<li>Automatic calculation of important time parameters based on the current number of users logged on and other parameters. This is to balance long response times against network load and to better scale when the number of users grow high (in which case the probing time is increased to save system resources).</li>
<li>Authenticated protocol between the daemon and the controlling processes (command line interface and cgi)</li>
<li>Ability to handle multiple access chains for each user, increasing the flexibility in access filter design.</li>
<li>All activites are logged via <i>syslog()</i></li>
<li>Statistics collection</li>
<li>Two different monitoring modes:
<ol>
<li>ARP-ping, i.e. regularly send out ARP requests and wait for answer.</li>
<li>PING, i.e. ICMP Echo Request/Reply, this mode is used when the client is behind another router.</li>
</ol>
</ul>
</p>
<h2>Platforms</h2>
<p>
Only Linux is supported for the daemon. It should be possible (but is not tested) to build the command line interface on other unix platforms or on Windows 2000/XP.
</p>
<h2>The configuration file</h2>
<p>
The following parameters can be placed in the configuration file:
<table border>
<tr><th>Category</th><th>Name</th><th>Description</th></tr>
<tr><td>server</td><td><i>syslog_facility</i></td><td>Name of the syslog "facility" to be used when logging.</td></tr>
<tr><td>server</td><td><i>syslog_name</i></td><td>The name to be used when logging to syslog.</td></tr>
<tr><td>server</td><td><i>pidfile</i></td><td>Name of a file in which to store the process PID.</td></tr>
<tr><td>server</td><td><i>listen_address</i></td><td>IP address or DNS-name that the process should listen to. Normally "<i>0.0.0.0</i>", since the process should be reached from multiple directions.</td></tr>
<tr><td>server</td><td><i>listen_port</i></td><td>Port number or <i>service</i> name that the process should listen on.</td></tr>
<tr><td>server</td><td><i>accept_interval</i></td><td>Interval in ms between
<i>select()</i>-calls for control connections. Tuning parameter.</td></tr>
<tr><td>server</td><td><i>accept_timeout</i></td><td>Timeout in ms for
<i>select()</i>-calls for control connections. Tuning parameter.</td></tr>
<tr><td>server</td><td><i>logout_timeout</i></td><td>Wanted time in seconds before a disconnected user is logged out.</td></tr>
<tr><td>server</td><td><i>min_pinginterval</i></td><td>Smallest number of  micro seconds between to consecutive sendings of ping (both ARP-ping and ICMP-ping).</td></tr>
<tr><td>server</td><td><i>missdiff</i></td><td>The number of seconds older the latest reply may be compared to the latest sent packed before the sent packet is classed as a miss.</td></tr>
<tr><td>server</td><td><i>key</i></td><td>The servers authentication key</td></tr>
<tr><td>server</td><td><i>accounting_lib</i></td><td>Path to a dynamic library for "accounting".</td></tr>
<tr><td>server</td><td><i>accounting_id</i></td><td>Program identifier for "accounting".</td></tr>
<tr><td>server</td><td><i>tracefile/i></td><td>Filname for the trace function. If this parameter exists, the trace function is activated.</td></tr>
<tr><td>server</td><td><i>flush_on_start</i></td><td>A list of iptables chains which are to be flushed at start.</td></tr>
<tr><td>client</td><td><i>ip</i></td><td>Clients IP address.</td></tr>
<tr><td>client</td><td><i>key</i></td><td>Clients autentication key.</td></tr>
<tr><td>client</td><td><i>perms</i></td><td>A list of commands this client has permission to execute. If any of the commands listed is "any", all commands are permitted.</td></tr>
</table>
</p>
<p>
Example configuration file:
<pre>
server nomad
        syslog_facility=local6
        syslog_name=iplogin2
        pidfile=/var/run/iplogin.pid
        listen_address=0.0.0.0
        listen_port=iplogin2
        accept_interval=30
        accept_timeout=20
        logout_imeout=25
        pinginterval=5000
        min_pinginterval=2000
        missdiff=2
        maxmissed=5
        key=The key to it all is fnurgel
        accounting_lib=./acclib_test.so
        accounting_id=iplogin
	flush_on_start=users,nat:users

client localhost
        ip=127.0.0.1
        key=sture
        perms=any
</pre>
</p>
<h2>Comments</h2>
<p>
<ul>
<li>The trace function is primarily intended as a way to verify that transmitting and receiving is working correctly. It generates a lot of text.</li>
<li>The name of an iptables chain can also specify which table should be altered. This is done by prefixing the chain name whith the table  name and a ":", e.g. "nat:users".</li>
<li>Daemonen can be started whith parameters telling it to load a state-file directly at start(<i>"-l &lt;loadfile&gt;</i>"). When the process is sent a <i>USR1</i> signal its current <i>state</i> will be saved to the same file given at the start. The signal <i>USR2</i> does the same thing but ends the daemin. This comes in handy when the systems needs to be rebooted because the users do not need to log in again.</li>
</ul>
</p>
<h2>Discussion</h2>
<p>
Because the raw ARP-packets needs to built up "by hand" and sent on a raw <i>socket</i>, we need to know the interface index for the interface each packet should be transmitted on. Therefore there is code that uses <i>netlink</i>. There are also some calls to <i>ioctl</i>-functions to get hold of the IP addresses. This, together with the tight connection whith <i>iptables</i>, makes porting of the program to anything else than Linux unlikely to success.
</p>
<h2>Synopsis</h2>
<p>
The server program:
<i><center>iplogin &lt;configuration file&gt; &lt;server name&gt; [ -l &lt;filename&gt; ]
</center></i> where "-l" is used to make the program load a users list already at start.
</p>
<p>
Administration command line interface - must be complied whith the correct path to configuration file and the correct client name.
<i><center>iladmin</center></i>
</p>
<p>
Commands understood by the server:
<table border>
<tr><th>Operation</th><th>Command</th></tr>
<tr>
<td>Add a new user</td>
<td><i>add &lt;address&gt; &lt;list of filter chains&gt;</i></td>
</tr>
<tr>
<td>Show information about a user</td>
<td><i>stat &lt;address&gt;</i></td>
</tr>
<tr>
<td>Check whethher a user is logged on</td>
<td><i>check &lt;address&gt;</i></td>
</tr>
<tr>
<td>Delete a user</td>
<td><i>del &lt;address&gt;</i></td>
</tr>
<tr>
<td>Reload filter chains</td>
<td><i>reload</i></td>
</tr>
<tr>
<td>Get help (list of commands)</td>
<td><i>help</i></td>
</tr>
<tr>
<td>Show information about all users</td>
<td><i>dump</i></td>
</tr>
<tr>
<td>Reset everything</td>
<td><i>reset</i></td>
</tr>
<tr>
<td>Terminate server program</td>
<td><i>quit</i></td>
</tr>
<tr>
<td>Save users list to a file</td>
<td><i>savestate &lt;filename&gt;</i></td>
</tr>
<tr>
<td>Load users list from a file</td>
<td><i>loadstate &lt;filname&gt;</i></td>
</tr>
<tr>
<td>Count number of logged on users</td>
<td><i>count</i></td>
</tr>
<tr>
<td>Find out iplogin:s current RSS (Resident Segment Size)</td>
<td><i>rss</i></td>
</tr>
<tr>
<td>Find out iplogin:s current vsize</td>
<td><i>vsize</i></td>
</tr>
<tr>
<td>Add blocking of a user</td>
<td><i>addblock &lt;address&gt; &lt;list of iptables chains&gt;</i></td>
</tr>
<tr>
<td>Remove blocking of a user</td>
<td><i>delblock &lt;address&gt; &lt;list of iptables chains&gt;</i></td>
</tr>
</table>
</p>
</body>
</html>
